<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/src/favicon.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vite App</title>
  </head>

  <body>
    <div id="root">
      <!--app-html-->
    </div>
    <script type="module">
      import ReactDOM from "react-dom";
      import React from "react";
      const hydrate = async () => {
        const templates = import.meta.glob("/src/templates/*.(jsx|tsx)");
        const routes = Object.keys(templates).map((path) => {
          return {
            name: path.split("/").pop()?.split(".")[0] || "index",
            path,
            getComponent: templates[path],
          };
        });
        const templateFilename = window._RSS_TEMPLATE_;
        const templateFilenameWithoutSuffix = templateFilename?.split(".")[0];
        const template = routes.find(
          (route) => route.name === templateFilenameWithoutSuffix
        ) || {
          name: templateFilename?.split(".")[0],
          path: `/src/templates/${templateFilename}`,
          getComponent: function () {
            throw new Error("Function not implemented.");
          },
        };
        const { default: Component } = await template.getComponent();
        if (!Component) {
          console.error("Default export missing in template: " + template.path);
          return;
        }
        ReactDOM.hydrate(
          /* @__PURE__ */ React.createElement(Component, {
            ...window._RSS_PROPS_,
          }),
          document.getElementById("root")
        );

        const urlParams = new URLSearchParams(window.location.search);
        const enableDebug = urlParams.get("yextCFDebug");
        if (enableDebug) {
          console.log("enable Custom Field Debugger");
          import("/src/customFieldDebugger/index.ts").then((module) => {
            function rerender(
              props,
              container = document.getElementById("root")
            ) {
              ReactDOM.render(
                /* @__PURE__ */ React.createElement(Component, {
                  ...props,
                }),
                container
              );
            }

            // Set up the profile proxy - this will log accesses to any field during rendering to `window.cfdProxyUsage`
            const proxyProps = module.getProxyProfile(window._RSS_PROPS_);
            // Provide the CF Debugger with a non-proxied version of the profile data so it doesn't trigger itself
            const noProxyProps = structuredClone(window._RSS_PROPS_);
            // Use the profile proxy & Rerender the page to log field accesses
            window._RSS_PROPS_ = proxyProps;
            rerender(window._RSS_PROPS_);

            module.initCFDebugger(rerender, noProxyProps);
          });
        }
      };
      hydrate();
    </script>
  </body>
</html>
